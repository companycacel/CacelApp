<UserControl x:Class="CacelApp.Views.Modulos.Configuracion.Configuracion"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:CacelApp.Views.Modulos.Configuracion"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:form="clr-namespace:CacelApp.Shared.Controls.Form"
             mc:Ignorable="d" 
             d:DesignHeight="950" d:DesignWidth="1200">

    <UserControl.Resources>
        <!-- Colores y Fuentes (Imitando Tailwind Minimalista) -->
        <SolidColorBrush x:Key="PrimaryBlueBrush" Color="#3b82f6"/>
        <SolidColorBrush x:Key="TextDarkBrush" Color="#1f2937"/>
        <SolidColorBrush x:Key="SecondaryGrayBrush" Color="#f4f4f5"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#e5e7eb"/>

        <!-- Estilo Base de Tarjeta (Card) -->
        <Style x:Key="CardStyle" TargetType="{x:Type Border}">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="Padding" Value="24"/>
            <Setter Property="Margin" Value="0,0,0,16"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="Gray" ShadowDepth="0" BlurRadius="5" Opacity="0.1"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Estilo para Expander (Paneles Colapsables de Balanzas) -->
        <Style TargetType="{x:Type Expander}">
            <Setter Property="Margin" Value="0,15,0,0"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
       
            <!-- Estilo del encabezado del Expander -->
            <Setter Property="HeaderTemplate">
                <Setter.Value>
                    <DataTemplate>
                        <!-- Usamos Border para CornerRadius y Padding -->
                        <Border Padding="15" Background="{StaticResource SecondaryGrayBrush}" CornerRadius="7,7,0,0">
                            <TextBlock Text="{Binding}" FontWeight="SemiBold" FontSize="14" Foreground="{StaticResource TextDarkBrush}"/>
                        </Border>
                    </DataTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Estilo para ListBox que muestra la lista de dispositivos -->
        <Style x:Key="DeviceListStyle" TargetType="{x:Type ListBox}">
            <Setter Property="Background" Value="{StaticResource SecondaryGrayBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
          
            <Setter Property="Padding" Value="8"/>
            <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto"/>
            <Setter Property="ItemContainerStyle">
                <Setter.Value>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0"/>
                    </Style>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Estilo para el ComboBox dentro de un FormField, para que se vea más limpio -->
        <Style x:Key="ComboBoxStyle" TargetType="{x:Type ComboBox}">
            <Setter Property="Padding" Value="6"/>
            <Setter Property="Height" Value="36"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
        
            <Setter Property="Margin" Value="0,4,0,0"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource TextDarkBrush}"/>
        </Style>

    </UserControl.Resources>

    <!-- Contenedor Principal (Fondo similar a secondary-gray) -->
    <Grid Background="{StaticResource SecondaryGrayBrush}">
        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0">

            <!-- Contenedor principal de todo el contenido. Ahora ocupa todo el ancho. -->
            <StackPanel Margin="24">

                <!-- HEADER (Texto superior) -->
                <TextBlock Text="Panel de Configuración" FontSize="30" FontWeight="ExtraBold" Foreground="{StaticResource TextDarkBrush}" Margin="0,0,0,4"/>
                <TextBlock Text="Gestión centralizada y dinámica de los parámetros de la aplicación." FontSize="14" Foreground="Gray" Margin="0,0,0,24"/>

                <!-- SECCIÓN DE CABECERA: ESTADO Y ACTUALIZACIÓN (50/50 Grid) -->
                <Grid Margin="0,0,0,25">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="20"/>
                        <!-- Más espacio entre tarjetas -->
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Tarjeta 1: Estado del Servicio -->
                    <Border Grid.Column="0" Style="{StaticResource CardStyle}" Margin="0">
                        <StackPanel>
                            <TextBlock Text="Estado del Servicio" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource TextDarkBrush}" Margin="0,0,0,10"/>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Indicador de Estado -->
                                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                    <Ellipse Width="10" Height="10" Fill="Green" Margin="0,0,8,0"/>
                                    <TextBlock Text="Activo" FontSize="15" FontWeight="Medium" Foreground="Green"/>
                                </StackPanel>

                                <!-- Botones de Acción -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                                    <form:CustomButton Command="{Binding ReiniciarCommand}"
                                                       Text="Reiniciar"
                                                       Variant="Custom"
                                                       BackgroundColor="#fcd34d"
                                                       Margin="0,0,10,0"/>
                                    <form:CustomButton Command="{Binding CerrarServicioCommand}"
                                                       Text="Cerrar Servicio"
                                                       Variant="Custom"
                                                       BackgroundColor="#dc2626"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- Tarjeta 2: Actualización -->
                    <Border Grid.Column="2" Style="{StaticResource CardStyle}" Margin="0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                <TextBlock Text="Actualizar Componente" FontSize="18" FontWeight="SemiBold" Foreground="{StaticResource TextDarkBrush}"/>
                                <TextBlock Text="Versión: v1.0.2 | Equipo: JOHAN" FontSize="12" Foreground="Gray" Margin="0,4,0,0"/>
                            </StackPanel>

                            <!-- Botón Buscar actualización -->
                            <form:CustomButton Grid.Column="1" 
                                               Command="{Binding BuscarActualizacionCommand}"
                                               Text="Buscar actualización"
                                               Variant="Custom"
                                               IconKind="Refresh"
                                               BackgroundColor="{StaticResource PrimaryBlueBrush}"
                                               VerticalAlignment="Center"
                                               Padding="15,8"/>
                        </Grid>
                    </Border>
                </Grid>

                <!-- SECCIÓN PRINCIPAL DE CONFIGURACIÓN -->
                <Border Style="{StaticResource CardStyle}" Padding="30">
                    <StackPanel>
                        <!-- Título principal -->
                        <Border BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,0,0,1" Padding="0,0,0,10" Margin="0,0,0,15">
                            <TextBlock Text="Ajustes de Conexión y Hardware" FontSize="22" FontWeight="SemiBold" Foreground="{StaticResource TextDarkBrush}"/>
                        </Border>

                        <!-- 1. Configuración General (WebApi y Sede) -->
                        <StackPanel Margin="0,15,0,0">
                            <Border BorderThickness="4,0,0,0" BorderBrush="{StaticResource PrimaryBlueBrush}" Padding="8,0,0,0" Margin="0,0,0,15">
                                <TextBlock Text="General" FontSize="16" FontWeight="Bold" Foreground="{StaticResource TextDarkBrush}"/>
                            </Border>

                            <Grid Margin="0,0,0,25">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="20"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Columna 1: WebApi -->
                                <form:FormField Grid.Column="0"
                                                Label="URL WebApi"
                                                Value="{Binding WebApi, Mode=TwoWay}" 
                                                d:Value="http://38.253.154.34:3001" />

                                <!-- Columna 2: Sede (usando un ComboBox nativo con el estilo adaptado) -->
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Sede" FontSize="13" Foreground="Gray"/>
                                    <ComboBox SelectedItem="{Binding Sede, Mode=TwoWay}" d:Text="PesajesA" Style="{StaticResource ComboBoxStyle}">
                                        <ComboBoxItem Content="PesajesA"/>
                                        <ComboBoxItem Content="PesajesB"/>
                                        <ComboBoxItem Content="BalanzaA"/>
                                    </ComboBox>
                                </StackPanel>
                            </Grid>
                        </StackPanel>

                        <!-- 2. Configuración FTP -->
                        <StackPanel Margin="0,15,0,0">
                            <Border BorderThickness="4,0,0,0" BorderBrush="{StaticResource PrimaryBlueBrush}" Padding="8,0,0,0" Margin="0,0,0,15">
                                <TextBlock Text="FTP/Almacenamiento" FontSize="16" FontWeight="Bold" Foreground="{StaticResource TextDarkBrush}"/>
                            </Border>
                            <Grid Margin="0,0,0,25">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="20"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Columna 1: Carpeta Local -->
                                <form:FormField Grid.Column="0"
                                                Label="Carpeta Local (Ruta de Imágenes)"
                                                Value="{Binding Ftp.Carpeta, Mode=TwoWay}" 
                                                d:Value="D://FTP"/>

                                <!-- Columna 2: Servidor FTP -->
                                <form:FormField Grid.Column="2"
                                                Label="URL Servidor FTP/HTTP"
                                                Value="{Binding Ftp.Servidor, Mode=TwoWay}" 
                                                d:Value="http://38.253.154.34:8086"/>
                            </Grid>
                        </StackPanel>

                        <!-- 3. Configuración de Balanzas (Paneles Colapsables/Expanders) -->
                        <StackPanel Margin="0,15,0,0" >
                            <Border BorderThickness="4,0,0,0" BorderBrush="{StaticResource PrimaryBlueBrush}" Padding="8,0,0,0" Margin="0,0,0,15">
                                <TextBlock Text="Detalle de Balanzas y DVRs" FontSize="16" FontWeight="Bold" Foreground="{StaticResource TextDarkBrush}"/>
                            </Border>

                            <!-- Expander 1: Balanzas de Pesajes Múltiples -->
                            <Expander Header="Balanzas de Pesajes Múltiples"  Padding="5">
                                <StackPanel  Background="White" Margin="15">
                                    <!-- Configuración DVR -->
                                    <TextBlock Text="Configuración de Grabador DVR" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,10"/>
                                    <Grid Margin="0,0,0,20">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="10"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="10"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <form:FormField Grid.Column="0" Value="{Binding Balanzas.Pesajes.DVR.Ip, Mode=TwoWay}" Label="IP DVR" d:Value="192.168.1.129"/>
                                        <form:FormField Grid.Column="2" Value="{Binding Balanzas.Pesajes.DVR.Usuario, Mode=TwoWay}" Label="Usuario" d:Value="user"/>

                                        <!-- CORRECCIÓN: Usamos PasswordBox nativo ya que FormField no soporta IsPassword -->
                                        <StackPanel Grid.Column="4">
                                            <TextBlock Text="Clave" FontSize="13" Foreground="Gray"/>
                                            <PasswordBox x:Name="PesajesClave" 
                                                         materialDesign:HintAssist.Hint="Clave"
                                                         Style="{StaticResource MaterialDesignFloatingHintPasswordBox}"
                                                         Height="36"
                                                         Margin="0,4,0,0"
                                                         />
                                            <!-- Nota: Necesitarías usar Attached Properties o un Behavior para el TwoWay Binding en PasswordBox. Aquí solo se muestra la estructura correcta. -->
                                        </StackPanel>
                                    </Grid>

                                    <!-- Lista de Dispositivos -->
                                    <TextBlock Text="Dispositivos Conectados (Grupos A, B, Otros)" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,10"/>
                                    <ListBox ItemsSource="{Binding Balanzas.Pesajes.Grupos}" Height="150" Style="{StaticResource DeviceListStyle}">
                                        <!-- Usar un DataTemplate para mostrar los grupos y dispositivos -->
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <!-- CORRECCIÓN: Border con Padding y CornerRadius para el estilo de tarjeta de la lista -->
                                                <Border Margin="0,5,0,5" Background="White" Padding="8" CornerRadius="4" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1">
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding Key, StringFormat='Grupo: {0}'}" FontWeight="Bold" FontSize="13" Foreground="{StaticResource TextDarkBrush}" Margin="0,0,0,3"/>
                                                        <ItemsControl ItemsSource="{Binding Value}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <!-- Balanza Device -->
                                                                    <Grid Margin="10,2,0,2">
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="*"/>
                                                                            <ColumnDefinition Width="Auto"/>
                                                                        </Grid.ColumnDefinitions>
                                                                        <TextBlock Grid.Column="0" FontSize="12">
                                                                            <Run Text="{Binding Nombre}" FontWeight="SemiBold"/>
                                                                            <Run Text=" | COM: "/>
                                                                            <Run Text="{Binding COM, FallbackValue='N/A'}"/>
                                                                        </TextBlock>
                                                                        <TextBlock Grid.Column="1" FontSize="12" Foreground="Gray">
                                                                            <Run Text="Cámaras: "/>
                                                                            <Run Text="{Binding Camaras, StringFormat=\{0\}, FallbackValue='-'}" />
                                                                        </TextBlock>
                                                                    </Grid>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                    <TextBlock Text="La gestión detallada (CRUD) de dispositivos de balanza se realiza en un módulo administrativo." 
                                               FontSize="11" Foreground="Gray" FontStyle="Italic" Margin="0,10,0,0"/>
                                </StackPanel>
                            </Expander>

                            <!-- Expander 2: Balanza Principal -->
                            <Expander Header="Balanza Principal de Peso Kg" Padding="5">
                                <StackPanel  Background="White" Margin="15">
                                    <!-- Configuración DVR -->
                                    <TextBlock Text="Configuración de Grabador DVR" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,10"/>
                                    <Grid Margin="0,0,0,20">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="10"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="10"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <form:FormField Grid.Column="0" Value="{Binding Balanzas.Balanza.DVR.Ip, Mode=TwoWay}" Label="IP DVR" d:Value="192.168.1.123"/>
                                        <form:FormField Grid.Column="2" Value="{Binding Balanzas.Balanza.DVR.Usuario, Mode=TwoWay}" Label="Usuario" d:Value="user"/>

                                        <!-- CORRECCIÓN: Usamos PasswordBox nativo ya que FormField no soporta IsPassword -->
                                        <StackPanel Grid.Column="4">
                                            <TextBlock Text="Clave" FontSize="13" Foreground="Gray"/>
                                            <PasswordBox x:Name="BalanzaClave" 
                                                         materialDesign:HintAssist.Hint="Clave"
                                                         Style="{StaticResource MaterialDesignFloatingHintPasswordBox}"
                                                         Height="36"
                                                         Margin="0,4,0,0"
                                                         />
                                        </StackPanel>
                                    </Grid>

                                    <!-- Lista de Dispositivos -->
                                    <TextBlock Text="Dispositivos Conectados (Grupo A)" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,10"/>
                                    <ListBox ItemsSource="{Binding Balanzas.Balanza.Grupos}" Height="80" Style="{StaticResource DeviceListStyle}">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <!-- CORRECCIÓN: Border con Padding y CornerRadius para el estilo de tarjeta de la lista -->
                                                <Border Margin="0,5,0,5" Background="White" Padding="8" CornerRadius="4" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="1">
                                                    <StackPanel>
                                                        <ItemsControl ItemsSource="{Binding Value}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Grid Margin="10,2,0,2">
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="*"/>
                                                                            <ColumnDefinition Width="Auto"/>
                                                                        </Grid.ColumnDefinitions>
                                                                        <TextBlock Grid.Column="0" FontSize="12">
                                                                            <Run Text="{Binding Nombre}" FontWeight="SemiBold"/>
                                                                            <Run Text=" | COM: "/>
                                                                            <Run Text="{Binding COM, FallbackValue='N/A'}"/>
                                                                        </TextBlock>
                                                                        <TextBlock Grid.Column="1" FontSize="12" Foreground="Gray">
                                                                            <Run Text="Cámaras: "/>
                                                                            <Run Text="{Binding Camaras, StringFormat=\{0\}, FallbackValue='-'}" />
                                                                        </TextBlock>
                                                                    </Grid>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </StackPanel>
                            </Expander>
                            
                        </StackPanel>

                        <!-- Botón de Guardar -->
                        <Grid Margin="0,30,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <form:CustomButton Grid.Column="1" 
                                               Command="{Binding GuardarConfiguracionCommand}"
                                               Text="Guardar Cambios"
                                               Variant="Save"
                                               Height="42"
                                               FontSize="15"
                                               Padding="20,0"/>
                        </Grid>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>