<UserControl x:Class="CacelApp.Views.Modulos.Configuracion.Configuracion"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:CacelApp.Views.Modulos.Configuracion"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:form="clr-namespace:CacelApp.Shared.Controls.Form"
             xmlns:dtControls="clr-namespace:CacelApp.Shared.Controls.DataTable"
             xmlns:converters="clr-namespace:CacelApp.Config.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="950" d:DesignWidth="1200">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InvBoolToVis"/>

        <SolidColorBrush x:Key="PrimaryBlueBrush" Color="#3b82f6"/>
        <SolidColorBrush x:Key="TextDarkBrush" Color="#1f2937"/>
        <SolidColorBrush x:Key="SecondaryGrayBrush" Color="#f4f4f5"/>
        <SolidColorBrush x:Key="BorderGrayBrush" Color="#e5e7eb"/>

        <Style x:Key="CardStyle" TargetType="{x:Type Border}">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderGrayBrush}"/>
            <Setter Property="Padding" Value="24"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="Gray" ShadowDepth="0" BlurRadius="5" Opacity="0.1"/>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Grid Background="{StaticResource SecondaryGrayBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" Padding="24,16" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="20"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0">
                    <TextBlock Text="API y Servidor" FontWeight="Bold" Margin="0,0,0,10"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <form:FormField Label="URL WebApi" Value="{Binding AppConfig.Global.WebApiUrl}"/>
                        <Button Grid.Column="1" Command="{Binding ProbarWebApiCommand}" Content="Probar" Margin="10,0,0,0" VerticalAlignment="Bottom" Style="{StaticResource MaterialDesignOutlinedButton}"/>
                    </Grid>
                </StackPanel>

                <StackPanel Grid.Column="2">
                    <TextBlock Text="FTP y Almacenamiento" FontWeight="Bold" Margin="0,0,0,10"/>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <form:FormField Label="URL Servidor FTP" Value="{Binding AppConfig.Global.Ftp.ServidorUrl}"/>
                        <Button Grid.Column="1" Command="{Binding ProbarFtpCommand}" Content="Probar" Margin="10,0,0,0" VerticalAlignment="Bottom" Style="{StaticResource MaterialDesignOutlinedButton}"/>
                    </Grid>

                    <form:FormField Label="Carpeta Local" Value="{Binding AppConfig.Global.Ftp.CarpetaLocal}" Margin="0,10,0,10"/>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="10"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <form:FormField Grid.Column="0" Label="Usuario FTP" Value="{Binding AppConfig.Global.Ftp.Usuario}"/>
                        <form:FormField Grid.Column="2" Label="Password FTP" Value="{Binding AppConfig.Global.Ftp.Password}"/>
                    </Grid>
                </StackPanel>
            </Grid>
        </Border>

        <ScrollViewer Grid.Row="1" Padding="24" VerticalScrollBarVisibility="Auto">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="300"/>
                    <ColumnDefinition Width="20"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Border Grid.Column="0" Style="{StaticResource CardStyle}" Padding="0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Padding="15" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,0,0,1">
                            <TextBlock Text="Sedes" FontWeight="Bold" FontSize="16"/>
                        </Border>

                        <ListBox Grid.Row="1" ItemsSource="{Binding AppConfig.Sedes}" SelectedItem="{Binding SedeSeleccionada}" BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="5">
                                        <TextBlock Text="{Binding Nombre}" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding Codigo}" FontSize="12" Foreground="Gray"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <Border Grid.Row="2" Padding="10" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,1,0,0">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Command="{Binding AgregarSedeCommand}" Style="{StaticResource MaterialDesignIconButton}" ToolTip="Agregar Sede">
                                    <materialDesign:PackIcon Kind="Plus"/>
                                </Button>
                                <Button Command="{Binding EliminarSedeCommand}" Style="{StaticResource MaterialDesignIconButton}" ToolTip="Eliminar Sede" Foreground="Red">
                                    <materialDesign:PackIcon Kind="Delete"/>
                                </Button>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>

                <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <Border Style="{StaticResource CardStyle}" 
                                Visibility="{Binding SedeSeleccionada, Converter={StaticResource BoolToVis}}">
                            <StackPanel>
                                <TextBlock Text="Detalle de Sede" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,15"/>

                                <Grid Margin="0,0,0,20">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <form:FormField Grid.Column="0" Label="Nombre Sede" Value="{Binding SedeSeleccionada.Nombre}"/>
                                    <form:FormField Grid.Column="2" Label="Código" Value="{Binding SedeSeleccionada.Codigo}"/>
                                </Grid>

                                <Separator Margin="0,0,0,20"/>

                                <TextBlock Text="Configuración DVR (Cámaras)" FontWeight="Bold" Margin="0,0,0,10"/>
                                <Grid Margin="0,0,0,20">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="2*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="1*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="1.5*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="1.5*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <form:FormField Grid.Column="0" Label="IP DVR" Value="{Binding SedeSeleccionada.Dvr.Ip}"/>
                                    <form:FormField Grid.Column="2" Label="Puerto" Value="{Binding SedeSeleccionada.Dvr.Puerto}"/>
                                    <form:FormField Grid.Column="4" Label="Usuario" Value="{Binding SedeSeleccionada.Dvr.Usuario}"/>
                                    <form:FormField Grid.Column="6" Label="Password" Value="{Binding SedeSeleccionada.Dvr.Password}"/>
                                    <Button Grid.Column="8" Command="{Binding ProbarDvrCommand}" Content="Probar" Style="{StaticResource MaterialDesignOutlinedButton}" VerticalAlignment="Bottom" Margin="0,0,0,4"/>
                                </Grid>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="20"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <GroupBox Grid.Column="0" Header="Balanzas (Máx 2)" Style="{StaticResource MaterialDesignCardGroupBox}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="*"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <ListBox Grid.Row="0" ItemsSource="{Binding SedeSeleccionada.Balanzas}" SelectedItem="{Binding BalanzaSeleccionada}" Height="200">
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid Margin="0,5">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="Auto"/>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <materialDesign:PackIcon Kind="Scale" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                                            <StackPanel Grid.Column="1">
                                                                <TextBlock Text="{Binding Nombre}" FontWeight="Bold"/>
                                                                <TextBlock FontSize="12">
                                                                    <Run Text="{Binding Puerto}"/>
                                                                    <Run Text=" | "/>
                                                                    <Run Text="{Binding BaudRate}"/>
                                                                </TextBlock>
                                                            </StackPanel>
                                                            <materialDesign:PackIcon Grid.Column="2" Kind="CheckCircle" Foreground="Green" Visibility="{Binding Conectada, Converter={StaticResource BoolToVis}}" ToolTip="Conectada"/>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>

                                            <StackPanel Grid.Row="1" Margin="0,10,0,0">
                                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,10">
                                                    <Button Command="{Binding AgregarBalanzaCommand}" Style="{StaticResource MaterialDesignIconButton}" ToolTip="Agregar Balanza">
                                                        <materialDesign:PackIcon Kind="Plus"/>
                                                    </Button>
                                                    <Button Command="{Binding EliminarBalanzaCommand}" CommandParameter="{Binding BalanzaSeleccionada}" Style="{StaticResource MaterialDesignIconButton}" ToolTip="Eliminar Balanza" Foreground="Red">
                                                        <materialDesign:PackIcon Kind="Delete"/>
                                                    </Button>
                                                    <Button Command="{Binding ProbarBalanzaCommand}" CommandParameter="{Binding BalanzaSeleccionada}" Style="{StaticResource MaterialDesignIconButton}" ToolTip="Probar Balanza" Foreground="{StaticResource PrimaryBlueBrush}">
                                                        <materialDesign:PackIcon Kind="Connection"/>
                                                    </Button>
                                                </StackPanel>

                                                <StackPanel Visibility="{Binding BalanzaSeleccionada, Converter={StaticResource BoolToVis}}">
                                                    <form:FormField Label="Nombre" Value="{Binding BalanzaSeleccionada.Nombre}" Margin="0,0,0,5"/>
                                                    <ComboBox ItemsSource="{Binding DataContext.PuertosDisponibles, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                              SelectedItem="{Binding BalanzaSeleccionada.Puerto}"
                                                              materialDesign:HintAssist.Hint="Puerto COM" Margin="0,0,0,10"/>
                                                    <ComboBox ItemsSource="{Binding DataContext.BaudRates, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                              SelectedItem="{Binding BalanzaSeleccionada.BaudRate}"
                                                              materialDesign:HintAssist.Hint="Baud Rate" Margin="0,0,0,10"/>
                                                    <Button Command="{Binding DataContext.ProbarBalanzaCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                            CommandParameter="{Binding BalanzaSeleccionada}"
                                                            Content="Probar Conexión" Style="{StaticResource MaterialDesignOutlinedButton}"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </Grid>
                                    </GroupBox>

                                    <GroupBox Grid.Column="2" Header="Cámaras" Style="{StaticResource MaterialDesignCardGroupBox}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="*"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <ListBox Grid.Row="0" ItemsSource="{Binding SedeSeleccionada.Camaras}" SelectedItem="{Binding CamaraSeleccionada}" Height="200">
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid Margin="0,5">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="Auto"/>
                                                                <ColumnDefinition Width="*"/>
                                                            </Grid.ColumnDefinitions>
                                                            <materialDesign:PackIcon Kind="Cctv" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                                            <StackPanel Grid.Column="1">
                                                                <TextBlock Text="{Binding Nombre}" FontWeight="Bold"/>
                                                                <TextBlock FontSize="12">
                                                                    <Run Text="Canal: "/>
                                                                    <Run Text="{Binding Canal}"/>
                                                                    <Run Text=" | "/>
                                                                    <Run Text="{Binding Ubicacion}"/>
                                                                </TextBlock>
                                                            </StackPanel>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>

                                            <StackPanel Grid.Row="1" Margin="0,10,0,0">
                                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,10">
                                                    <Button Command="{Binding AgregarCamaraCommand}" Style="{StaticResource MaterialDesignIconButton}" ToolTip="Agregar Cámara">
                                                        <materialDesign:PackIcon Kind="Plus"/>
                                                    </Button>
                                                    <Button Command="{Binding EliminarCamaraCommand}" CommandParameter="{Binding CamaraSeleccionada}" Style="{StaticResource MaterialDesignIconButton}" ToolTip="Eliminar Cámara" Foreground="Red">
                                                        <materialDesign:PackIcon Kind="Delete"/>
                                                    </Button>
                                                </StackPanel>

                                                <StackPanel Visibility="{Binding CamaraSeleccionada, Converter={StaticResource BoolToVis}}">
                                                    <form:FormField Label="Nombre" Value="{Binding CamaraSeleccionada.Nombre}" Margin="0,0,0,5"/>
                                                    <form:FormField Label="Canal (1-32)" Value="{Binding CamaraSeleccionada.Canal}" Margin="0,0,0,5"/>
                                                    <form:FormField Label="Ubicación" Value="{Binding CamaraSeleccionada.Ubicacion}" Margin="0,0,0,5"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </Grid>
                                    </GroupBox>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <Border Style="{StaticResource CardStyle}" 
                                Visibility="{Binding SedeSeleccionada, Converter={StaticResource InvBoolToVis}}" 
                                VerticalAlignment="Center" 
                                HorizontalAlignment="Center">
                            <TextBlock Text="Seleccione una sede para ver su configuración" Foreground="Gray" FontStyle="Italic"/>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </ScrollViewer>
        <Border Grid.Row="2" Background="White" Padding="24,16" BorderBrush="{StaticResource BorderGrayBrush}" BorderThickness="0,1,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <form:CustomButton Command="{Binding CancelarCommand}" 
                                   Variant="Close" 
                                   Text="Cancelar"
                                   IsOutlined="True"
                                   Margin="0,0,10,0"/>

                <form:CustomButton Command="{Binding GuardarCommand}" 
                                   Variant="Save" Text="Guardar Configuración" IsOutlined="True"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>