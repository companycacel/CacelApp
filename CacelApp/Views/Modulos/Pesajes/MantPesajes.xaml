<Window x:Class="CacelApp.Views.Modulos.Pesajes.MantPesajes"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:converters="clr-namespace:CacelApp.Config.Converters"
        xmlns:controls="clr-namespace:CacelApp.Shared.Controls.DataTable"
        xmlns:form="clr-namespace:CacelApp.Shared.Controls.Form"
        xmlns:loading="clr-namespace:CacelApp.Shared.Controls.Loading"
        mc:Ignorable="d"
        Title="{Binding Titulo}" 
        Height="910" 
        Width="1500"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource MaterialDesignPaper}" 
    ResizeMode="CanResize">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>

        <!-- Estilo para la Tarjeta (Card) - Adaptable a modo dark/light -->
        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource MaterialDesignCardBackground}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource MaterialDesignDivider}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Margin" Value="0,0,0,16"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="6" ShadowDepth="2" Opacity="0.1" Color="#000000"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Estilo para el Display de Peso Digital -->
        <Style x:Key="WeightDisplay" TargetType="TextBlock">
            <Setter Property="FontSize" Value="42"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="TextAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- DataTemplate para Botones de Acciones en Detalle (cambian según IsEditing) -->
        <DataTemplate x:Key="DetalleAccionesTemplate">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <!-- Botones cuando NO está en modo edición -->
                <Button Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding DataContext.EditarDetalleCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        CommandParameter="{Binding Item}"
                        ToolTip="Editar"
                        Width="32"
                        Height="32"
                        Margin="2,0">
                    <Button.Visibility>
                        <Binding Path="Item.IsEditing" Converter="{StaticResource InverseBooleanToVisibilityConverter}"/>
                    </Button.Visibility>
                    <materialDesign:PackIcon Kind="Edit" Width="18" Height="18" Foreground="#3B82F6"/>
                </Button>

                <Button Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding DataContext.EliminarDetalleCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        CommandParameter="{Binding Item}"
                        ToolTip="Eliminar"
                        Width="32"
                        Height="32"
                        Margin="2,0">
                    <Button.Visibility>
                        <Binding Path="Item.IsEditing" Converter="{StaticResource InverseBooleanToVisibilityConverter}"/>
                    </Button.Visibility>
                    <materialDesign:PackIcon Kind="Delete" Width="18" Height="18" Foreground="#EF4444"/>
                </Button>

                <!-- Botones cuando SÍ está en modo edición -->
                <Button Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding DataContext.GuardarDetalleCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        CommandParameter="{Binding Item}"
                        ToolTip="Guardar"
                        Width="32"
                        Height="32"
                        Margin="2,0">
                    <Button.Visibility>
                        <Binding Path="Item.IsEditing" Converter="{StaticResource BooleanToVisibilityConverter}"/>
                    </Button.Visibility>
                    <materialDesign:PackIcon Kind="ContentSave" Width="18" Height="18" Foreground="#10B981"/>
                </Button>

                <Button Style="{StaticResource MaterialDesignIconButton}"
                        Command="{Binding DataContext.CancelarEdicionDetalleCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                        CommandParameter="{Binding Item}"
                        ToolTip="Cancelar"
                        Width="32"
                        Height="32"
                        Margin="2,0">
                    <Button.Visibility>
                        <Binding Path="Item.IsEditing" Converter="{StaticResource BooleanToVisibilityConverter}"/>
                    </Button.Visibility>
                    <materialDesign:PackIcon Kind="Close" Width="18" Height="18" Foreground="#F59E0B"/>
                </Button>
            </StackPanel>
        </DataTemplate>

        <!-- DataTemplate para Ver Capturas (Ícono de cámara) -->
        <DataTemplate x:Key="DetalleCapturasTemplate">
            <Button Style="{StaticResource MaterialDesignIconButton}"
                    Command="{Binding DataContext.VerCapturasCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                    CommandParameter="{Binding Item}"
                    ToolTip="Ver capturas"
                    Width="32"
                    Height="32"
                    HorizontalAlignment="Center">
                <Button.Visibility>
                    <Binding Path="Item.HasImages" Converter="{StaticResource BooleanToVisibilityConverter}"/>
                </Button.Visibility>
                <materialDesign:PackIcon Kind="Camera" Width="20" Height="20" Foreground="#8B5CF6"/>
            </Button>
        </DataTemplate>
        <DataTemplate x:Key="DetalleDocumentoTemplate">
            <Grid>
                <!-- Mostrar texto cuando NO está editando -->
                <TextBlock Text="{Binding Item.Pde_mde_des}"
                           VerticalAlignment="Center"
                           Margin="8,0">
                    <TextBlock.Visibility>
                        <Binding Path="Item.IsEditing" Converter="{StaticResource InverseBooleanToVisibilityConverter}"/>
                    </TextBlock.Visibility>
                </TextBlock>

                <!-- Mostrar botón de búsqueda cuando SÍ está editando -->
                <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                    Command="{Binding DataContext.BuscarDocumentoCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                    Height="32"
                    Margin="4,0"
                    HorizontalContentAlignment="Left">
                    <Button.Visibility>
                        <Binding Path="Item.IsEditing" Converter="{StaticResource BooleanToVisibilityConverter}"/>
                    </Button.Visibility>
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="FileDocumentOutline" 
                                                 Width="16" 
                                                 Height="16" 
                                                 VerticalAlignment="Center"
                                                 Margin="0,0,8,0"/>
                        <TextBlock Text="{Binding Item.Pde_mde_des, TargetNullValue='BUSCAR'}" 
                                   VerticalAlignment="Center"
                                   FontSize="12"/>
                    </StackPanel>
                </Button>
            </Grid>
        </DataTemplate>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <loading:LoadingOverlay Grid.RowSpan="3" Panel.ZIndex="99999" Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"/>
        <Border Grid.Row="0"  Padding="24,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Icono + Título -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">

                    <materialDesign:PackIcon Kind="Scale" VerticalAlignment="Center"   Width="30"  Height="30" Foreground="{DynamicResource MaterialDesignBody}"/>
                    <StackPanel Orientation="Vertical" VerticalAlignment="Center" Margin="10,0" >
                        <TextBlock Text="Mantenimiento de Pesajes"
                               FontSize="18"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource MaterialDesignBody}"
                               VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>

                <!-- Estado + Fecha -->
                <StackPanel Grid.Column="2" 
                            Orientation="Horizontal" 
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center">
                    <!-- Indicador de estado -->
                    <Border Background="White" 
                            CornerRadius="12"
                            Padding="20,6"
                            Margin="0,0,6,0">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <Ellipse Width="8" 
                                     Height="8" 
                                     VerticalAlignment="Center" 
                                     Margin="0,0,8,0">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="#10B981"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Pes_status}" Value="1">
                                                <Setter Property="Fill" Value="#10B981"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Pes_status}" Value="3">
                                                <Setter Property="Fill" Value="#F59E0B"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <TextBlock Text="{Binding Pes_statusText, FallbackValue='PROCESADO'}" 
                                       FontSize="13"
                                       FontWeight="SemiBold"
                                       Foreground="#1F2937"/>
                        </StackPanel>
                    </Border>
                    <Border Background="White" CornerRadius="12"  Padding="20,4">
                        <form:FormDatePicker Value="{Binding Pes_fecha, StringFormat='Fecha: {0:dd/MM/yyyy}' , FallbackValue='Fecha: 18/11/2025'}" Label="Fecha"  Opacity="0.9"  />
                    </Border>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Content Principal con ScrollViewer -->
        <ScrollViewer Grid.Row="1" 
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      Padding="20">
            <StackPanel Margin="16">

                <!-- Top Section: Información General + Balanzas (4 Columnas Proporcionales) -->
                <Grid >
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Col 0: Información General -->
                    <Border Grid.Column="0" Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <form:FormField Grid.Column="0"
                                                Label="Ticket Electrónico"
                                                Value="{Binding Pes_baz_des, UpdateSourceTrigger=PropertyChanged}"
                                                IsReadOnly="True"
                                                Margin="0,0,10,10" />

                                <form:FormField Grid.Column="1"
                                                Label="Compra Tercero"
                                                Value="{Binding Pes_mov_des, UpdateSourceTrigger=PropertyChanged}"
                                                IsReadOnly="True"
                                                Margin="10,0,0,10" />
                            </Grid>

                            <form:FormField Label="Referencia (*)"
                                            Value="{Binding Pes_referencia, UpdateSourceTrigger=PropertyChanged}"
                                            IsEnabled="{Binding EsBloqueado}" />

                            <TextBlock Text="Todos los campos con asterisco (*) son obligatorios."
                                       FontSize="10"
                                       Foreground="#F87171"
                                       Margin="0,4,0,0"/>

                        </StackPanel>
                    </Border>

                    <!-- Col 2: Balanza 1 (B1-A) Live Display -->
                    <Border Grid.Column="2" 
                            Style="{StaticResource CardStyle}"
                            BorderBrush="#4F46E5" 
                        BorderThickness="2"
                            Padding="16">
                        <StackPanel>
                            <Border Background="{DynamicResource MaterialDesignTextFieldBoxBackground}"
                                    BorderBrush="{DynamicResource MaterialDesignDivider}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="16,12"
                                    Margin="0,4,0,8"
                                    Height="60">
                                <TextBlock Style="{StaticResource WeightDisplay}"
                                           Text="{Binding PesoB1, StringFormat='0.00', TargetNullValue='0.00'}"
                                           Foreground="#4F46E5"/>
                            </Border>

                            <form:CustomButton Command="{Binding CapturarB1Command}"  Variant="Close" Text="Captura B1-A" Height="38" IconKind="Camera" BackgroundColor="#4F46E5" Margin="0,0,12,0" />
                        </StackPanel>
                    </Border>
                    <Border Grid.Column="4" 
                            Style="{StaticResource CardStyle}"
                            BorderBrush="#10B981"
                        BorderThickness="2"
                            Padding="16">
                        <StackPanel>

                            <!-- Display de Peso -->
                            <Border Background="{DynamicResource MaterialDesignTextFieldBoxBackground}"
                                    BorderBrush="{DynamicResource MaterialDesignDivider}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="16,12"
                                    Margin="0,4,0,8"
                                    Height="60">
                                <TextBlock Style="{StaticResource WeightDisplay}"
                                           Text="{Binding PesoB2, StringFormat='0.00', TargetNullValue='0.00'}"
                                           Foreground="#10B981"/>
                                <!-- Color Verde para el peso -->
                            </Border>
                            <form:CustomButton Command="{Binding CapturarB2Command}"  Variant="Close" Text="Captura B2-A" Height="38" IconKind="Camera" BackgroundColor="#10B981" Margin="0,0,12,0" />
                        </StackPanel>
                    </Border>
                </Grid>


                <!-- Input Panel (Master-Detail) -->
                <Border Style="{StaticResource CardStyle}" Padding="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="3*"/>   
                            <ColumnDefinition Width="1.5*"/> 
                            <ColumnDefinition Width="1.5*"/> 
                            <ColumnDefinition Width="1*"/>   
                            <ColumnDefinition Width="1*"/>   
                            <ColumnDefinition Width="2*"/>   
                            <ColumnDefinition Width="Auto"/> 
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Margin="0,0,8,0" VerticalAlignment="Bottom" Visibility="{Binding EsDevolucion, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <form:FormField Value="{Binding ItemEdicion.Pde_mde_des}" 
                                                Label="DOC"
                                                IsReadOnly="True"
                                                Width="120" />
                                <Button Grid.Column="1" Command="{Binding BuscarDocumentoCommand}"
                                        Style="{StaticResource MaterialDesignIconButton}"
                                        Height="32" Width="32" Margin="4,10,0,0" VerticalAlignment="Bottom">
                                    <materialDesign:PackIcon Kind="Magnify"/>
                                </Button>
                            </Grid>
                        </StackPanel>

                        <!-- MATERIAL -->
                        <form:FormComboBox Grid.Column="1" Margin="4,0" VerticalAlignment="Bottom"
                                           Label="MATERIAL"
                                           Value="{Binding ItemEdicion.Pde_bie_id}"
                                           Options="{Binding MaterialOptions}"
                                           IsFilterEnabled="True"/>

                        <!-- BALANZA -->
                        <form:FormComboBox Grid.Column="2" Margin="4,0" VerticalAlignment="Bottom"
                                           Label="N° BALANZA"
                                           Value="{Binding ItemEdicion.Pde_nbza}"
                                           Options="{Binding BalanzaOptions}"/>

                        <!-- PESO BRUTO -->
                        <form:FormField Grid.Column="3" Margin="4,0" VerticalAlignment="Bottom"
                                        Label="P. BRUTO"
                                        Value="{Binding ItemEdicion.Pde_pb}"
                                        IsReadOnly="{Binding ItemEdicion.IsPesoBrutoReadOnly}"
                                        Variant="Decimal"/>

                        <!-- PESO TARA -->
                        <form:FormField Grid.Column="4" Margin="4,0" VerticalAlignment="Bottom"
                                        Label="P. TARA"
                                        Value="{Binding ItemEdicion.Pde_pt}"
                                        Variant="Decimal"/>

                        <!-- PESO NETO -->
                        <form:FormField Grid.Column="5" Margin="4,0" VerticalAlignment="Bottom"
                                        Label="P. NETO"
                                        Value="{Binding ItemEdicion.Pde_pn}"
                                        IsReadOnly="True"
                                        Variant="Decimal"/>

                        <!-- OBSERVACION -->
                        <form:FormField Grid.Column="6" Margin="4,0" VerticalAlignment="Bottom"
                                        Label="OBSERVACIÓN"
                                        Value="{Binding ItemEdicion.Pde_obs}"/>

                        <!-- ACTIONS -->
                        <StackPanel Grid.Column="7" Orientation="Horizontal" VerticalAlignment="Bottom" Margin="8,0,0,0">
                            <Button Command="{Binding GuardarDetalleCommand}"
                                    Style="{StaticResource MaterialDesignFloatingActionMiniButton}"
                                    ToolTip="Guardar Detalle"
                                    Height="36" Width="36" Background="#007bff" BorderBrush="#007bff" Margin="0,0,8,0">
                                <materialDesign:PackIcon Kind="ContentSave" Width="20" Height="20" Foreground="White"/>
                            </Button>
                            <Button Command="{Binding CancelarEdicionDetalleCommand}"
                                    Style="{StaticResource MaterialDesignFloatingActionMiniButton}"
                                    ToolTip="Cancelar / Limpiar"
                                    Height="36" Width="36" 
                                    Background="#EF4444" BorderBrush="#EF4444">
                                <materialDesign:PackIcon Kind="Close" Width="20" Height="20" Foreground="White"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Detalle de Materiales (Tabla con acciones en header) -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel>

                        <!-- DataTable Control con HeaderActions -->
                        <controls:DataTableControl DataContext="{Binding DetallesTable}"
                                                   Columns="{Binding DataContext.ColumnasDetalles, RelativeSource={RelativeSource AncestorType=Window}}"
                                                   HeaderActions="{Binding DataContext.AccionesHeader, RelativeSource={RelativeSource AncestorType=Window}}"
                                                   MaxHeight="400"
                                                   RowHeight="36"/>
                    </StackPanel>
                </Border>

                <!-- Observaciones -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel>
                        <TextBlock Text="Observaciones"
                                   FontSize="16"
                                   FontWeight="Bold"
                                   Margin="0,0,0,12"
                                   Foreground="{DynamicResource MaterialDesignBody}"/>

                        <form:FormField Label="Añadir observaciones aquí..."
                                        Value="{Binding Pes_obs, UpdateSourceTrigger=PropertyChanged}"
                                        AcceptsReturn="True"
                                        MinHeight="80"
                                        IsEnabled="{Binding EsBloqueado, Converter={StaticResource InverseBooleanConverter}}" />
                    </StackPanel>
                </Border>

            </StackPanel>
        </ScrollViewer>

        <!-- Botones de Acción al Final (Footer Limpio) -->
        <Border Grid.Row="2" 
                Background="{DynamicResource MaterialDesignCardBackground}"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="0,1,0,0"
                Padding="24,16">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">

                <form:CustomButton Command="{Binding CancelarCommand}"
                                   Variant="Close"
                                   Height="38"
                                   Margin="0,0,12,0" Text="Cerrar"/>

                <form:CustomButton Command="{Binding GuardarCommand}"
                                   Variant="Save"
                                   Height="38"
                                   Text="Actualizar Pesaje"
                                   IsEnabled="{Binding EsBloqueado, Converter={StaticResource InverseBooleanConverter}}" />
            </StackPanel>
        </Border>
    </Grid>
</Window>
