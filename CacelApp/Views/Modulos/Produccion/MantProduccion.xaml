<Window x:Class="CacelApp.Views.Modulos.Produccion.MantProduccion"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:converters="clr-namespace:CacelApp.Config.Converters"
        xmlns:form="clr-namespace:CacelApp.Shared.Controls.Form" xmlns:loading="clr-namespace:CacelApp.Shared.Controls.Loading"
        mc:Ignorable="d"
        Title="Mantenimiento Producción" 
        Height="810" 
        Width="1000"
        WindowStartupLocation="CenterScreen">
    <!-- Fondo muy claro -->

    <Window.Resources>
        <!-- CONVERTERS (Asumo que están definidos en tu proyecto) -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>

        <!-- ESTILOS GENERALES -->
        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource MaterialDesignCardBackground}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource MaterialDesignDivider}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Margin" Value="0,0,0,16"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="6" ShadowDepth="2" Opacity="0.1" Color="{DynamicResource MaterialDesignShadow}"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- No usamos BorderedInput para los campos de FormField/ComboBox/DatePicker, ya que los CustomControls deben manejar su propio estilo interno. -->
        <Style x:Key="WeightDisplay" TargetType="TextBlock">
            <Setter Property="FontSize" Value="36"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="TextAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <loading:LoadingOverlay Grid.RowSpan="3" Panel.ZIndex="99999" Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"/>
        <!-- Header: Título y Mensaje de Obligatoriedad -->
        <Border Grid.Row="0" 
                Background="{StaticResource AppPrimaryBrush}"
                Padding="24,20"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="0,0,0,1"
                >
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel  Grid.Column="0"  Orientation="Horizontal" VerticalAlignment="Center">
                <materialDesign:PackIcon Kind="ProgressAuto" Width="28" Height="28" 
                        Foreground="White"
                        VerticalAlignment="Center" Margin="0,0,15,0"/>
                <TextBlock Text="Mantenimiento Producción"
                           FontSize="20"
                           FontWeight="Bold"
                           Foreground="White"/>
    
            </StackPanel>
                <!-- N° Ticket en el header -->
                <Border Grid.Column="2" 
                  Background="{DynamicResource MaterialDesignCardBackground}" 
                  CornerRadius="8"
                  Padding="20,10"
                  VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="N° Registro:" 
                     FontWeight="SemiBold"
                     FontSize="14"
                     Foreground="{DynamicResource MaterialDesignBody}"
                     VerticalAlignment="Center"
                     Margin="0,0,15,0"/>
                        <TextBlock Text="{Binding NTicket, TargetNullValue='- - -'}" 
                     FontSize="24"
                     FontWeight="Bold"
                     Foreground="{StaticResource AppPrimaryBrush}"
                     VerticalAlignment="Center"
                     MinWidth="100"
                     TextAlignment="Center"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- Content Principal con ScrollViewer -->
        <ScrollViewer Grid.Row="1" 
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      Padding="20"
                      Background="{DynamicResource MaterialDesignPaper}">
            <StackPanel  Margin="16,16,16,0">

                <!-- Top Section: Información de Referencia + Balanzas (4 Columnas Proporcionales) -->
                <Grid Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <!-- Información General (40%) -->
                        <ColumnDefinition Width="2*"/>
                        <ColumnDefinition Width="20"/>
                        <!-- Separador -->
                        <!-- Balanza 1 (30%) -->
                        <ColumnDefinition Width="1.5*"/>
                        <ColumnDefinition Width="20"/>
                        <!-- Separador -->
                        <!-- Balanza 2 (30%) -->
                        <ColumnDefinition Width="1.5*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Col 0: Datos de Producción y Referencia (Usando Custom Controls) -->
                    <Border Grid.Column="0" Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="Datos de Referencia"
                                       FontSize="16"
                                       FontWeight="Bold"
                                       Margin="0,0,0,16"
                                       Foreground="{DynamicResource MaterialDesignBody}"/>

                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Fecha y Hora (Custom Control) -->
                                <form:FormDatePicker Grid.Column="0"
                                            Label="Fecha (*)"
                                            Value="{Binding Pes_fecha, Mode=TwoWay}"
                                            Margin="0,0,10,0"/>

                                <!-- Responsable (Custom Control) -->
                                <form:FormComboBox Grid.Column="1"
                                          Label="Responsable (*)"
                                          Options="{Binding Responsables}"
                                          Value="{Binding Pes_col_id, Mode=TwoWay}"
                                          Margin="10,0,0,0"/>
                            </Grid>

                            <!-- Materia Prima (Custom Control) -->
                            <form:FormComboBox Label="Materia Prima (*)"
                                      Options="{Binding Materiales}"
                                      Value="{Binding Pde_bie_id, Mode=TwoWay}"
                                      ExtData="{Binding MaterialExtData, Mode=TwoWay}"
                                      Margin="0,0,0,10"/>

                            <!-- U. Medida (Custom Control) -->
                            <form:FormComboBox Label="U. Medida (*)"
                                      Options="{Binding UnidadesMedida}"
                                      Value="{Binding Pde_t6m_id, Mode=TwoWay}"
                                      Margin="0,0,0,10"/>
                        </StackPanel>
                    </Border>

                    <!-- Col 2: Balanza 1 (B1-A) Live Display + Captura -->
                    <Border Grid.Column="2" 
                            Style="{StaticResource CardStyle}"
                            BorderBrush="#4F46E5" 
                        BorderThickness="2"
                            Padding="16">
                        <StackPanel>
                            <TextBlock FontWeight="Bold"
                                       FontSize="14"
                                       HorizontalAlignment="Center"
                                       Foreground="#4F46E5"
                                       Margin="0,0,0,8">
                                <Run Text="Balanza 1 ( B1-A )"/>
                            </TextBlock>

                            <!-- Display de Peso -->
                            <Border Background="#F9FAFB"
                                    BorderBrush="#E5E7EB"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="16,12"
                                    Margin="0,4,0,8">
                                <TextBlock Style="{StaticResource WeightDisplay}"
                                           Text="{Binding PesoB1, StringFormat='0.00', TargetNullValue='0.00'}"
                                           Foreground="#4F46E5"/>
                            </Border>

                            <TextBlock Text="KG | ESTADO: LISTO"
                                       FontSize="10"
                                       Foreground="#6B7280"
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,12"/>

                            <!-- Botón de Captura B1-A -->
                            <form:CustomButton Command="{Binding CapturarB1Command}"  Variant="Close" Text="Captura B1-A" Height="38" IconKind="Camera" BackgroundColor="#4F46E5" Margin="0,0,12,0" />
                        </StackPanel>
                    </Border>

                    <!-- Col 4: Balanza 2 (B2-A) Live Display + Captura -->
                    <Border Grid.Column="4" 
                            Style="{StaticResource CardStyle}"
                            BorderBrush="#10B981" 
                        BorderThickness="2"
                            Padding="16">
                        <StackPanel>
                            <TextBlock FontWeight="Bold"
                                       FontSize="14"
                                       HorizontalAlignment="Center"
                                       Foreground="#10B981"
                                       Margin="0,0,0,8">
                                <Run Text="Balanza 2 ( B2-A )"/>
                            </TextBlock>

                            <!-- Display de Peso -->
                            <Border Background="#F9FAFB"
                                    BorderBrush="#E5E7EB"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Padding="16,12"
                                    Margin="0,4,0,8">
                                <TextBlock Style="{StaticResource WeightDisplay}"
                                           Text="{Binding PesoB2, StringFormat='0.00', TargetNullValue='0.00'}"
                                           Foreground="#10B981"/>
                            </Border>

                            <TextBlock Text="KG | ESTADO: PESANDO"
                                       FontSize="10"
                                       Foreground="#6B7280"
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,12"/>

                            <!-- Botón de Captura B2-A -->
                            <form:CustomButton Command="{Binding CapturarB2Command}"  Variant="Close" Text="Captura B2-A" Height="38" IconKind="Camera" BackgroundColor="#10B981" Margin="0,0,12,0" />
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Section: Pesos de Producción (Usando Custom Controls) -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel>
                        <TextBlock Text="Pesos de Producción"
                                   FontSize="16"
                                   FontWeight="Bold"
                                   Margin="0,0,0,12"
                                   Foreground="{DynamicResource MaterialDesignBody}"/>

                        <Grid Margin="0,0,0,6">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="1.2*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Balanza Seleccionada (Custom Control) -->
                            <form:FormComboBox Grid.Column="0"
                                      Label="Nro. Balanza (*)"
                                      Options="{Binding Balanzas}"
                                      Value="{Binding Pde_nbza, Mode=TwoWay}"
                                      Margin="0,0,6,0"/>

                            <!-- Peso Bruto (Custom Control) -->
                            <form:FormField Grid.Column="1"
                                     Label="Peso Bruto (*)"
                                     Value="{Binding Pde_pb, Mode=TwoWay, FallbackValue='0.00'}"
                                 
                                     Margin="6,0,6,0"/>

                            <!-- Peso Tara (Custom Control) -->
                            <form:FormField Grid.Column="2"
                                     Label="Peso Tara (*)"
                                     Value="{Binding Pde_pt, Mode=TwoWay, FallbackValue='0.00'}"
                                  
                                     Margin="6,0,6,0"/>

                            <!-- Peso Neto (Custom Control - Solo Lectura) -->
                            <form:FormField Grid.Column="3"
                                     Label="Peso Neto (KG)"
                                     Value="{Binding Pde_pn, Mode=TwoWay,FallbackValue='0.00'}"
                                     IsReadOnly="True"
                                   
                                     Margin="6,0,0,0"/>

                        </Grid>
                        <TextBlock Text="El Peso Neto se calcula automáticamente (Bruto - Tara)."
                                   FontSize="10"
                                   Foreground="#6B7280"
                                   Margin="0,2,0,0"/>
                    </StackPanel>
                </Border>

                <!-- Observaciones (Usando Custom Control) -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel>
                        <TextBlock Text="Observaciones"
                                   FontSize="16"
                                   FontWeight="Bold"
                                   Margin="0,0,0,12"
                                   Foreground="{DynamicResource MaterialDesignBody}"/>

                        <!-- Asumo que el FormField puede manejar multilinea (AcceptsReturn=True y MinHeight) -->
                        <form:FormField Label="Añadir observaciones aquí..."
                                        Variant="TextArea"
                                        Value="{Binding Pde_obs, Mode=TwoWay}"
                                        MinHeight="80"
                                        AcceptsReturn="True"
                                        TextWrapping="Wrap"
                                        />
                    </StackPanel>
                </Border>

            </StackPanel>
        </ScrollViewer>

        <!-- Botones de Acción al Final (Footer Limpio) -->
        <Border Grid.Row="2" 
                Background="{DynamicResource MaterialDesignCardBackground}"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="0,1,0,0"
                Padding="20,16">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">

                <form:CustomButton Command="{Binding CancelarCommand}"
                                   Variant="Close"
                                   Height="38"
                                   Margin="0,0,12,0" Text="Cancelar"/>

                <form:CustomButton Command="{Binding GuardarCommand}"
                                   Variant="Save"
                                   Height="38"
                                   Text="Guardar Producción"
                                   IsEnabled="{Binding EsBloqueado, Converter={StaticResource InverseBooleanConverter}}" />
                
              
            </StackPanel>
        </Border>
    </Grid>
</Window>
